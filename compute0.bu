variant: fcos
version: 1.6.0
passwd:
  users:
    - name: core
      groups:
        - wheel
      password_hash: $1$OFBMchdV$IW6fiskmftI3AhmBpctvh.
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCv9JcP/0swLDVczhj418Jf1jkwQROA3hX3Ebs6OXQXAzBorHIpSofmTC3OP9Wh7TqStuQm65XzPEStqdokD55lZN7oYhYK4/u3Zmd5UQ8mSuAJO4Vp3GGHCWIwkbp8ke6Z3QZCuD6wHHO6qce3jbk4nCepA+P4U2iUfZ8Fn3rU3jgba7KbW9y8H2MJrY4qLfE84qg+R+hDI51fIBcAJP/fVBSVxniKRvMYn2tafxYpgXCgKnGc1eHyoCAXU5Kh3EvTVtaBPnFY1tBvb4EqRNKeZQ01/3HDqWYlaDjVtnt3BGd05pCro9CUuCyCL/gBOYe3ccr7UO7DrPh5itJKUVtgZA8WvVFFuaNveFqmP+7kBc535QAaOg5FqkGmJpSyFVt2RkNk9ErDrhYN3jn3VhXl4yAcK0KV5jBvcwjTUDzdy/bKrLvKv5c466/ynbkhoj0X8/ID36zetraKcUZ2NAlo93HM2skRVTGrS6BZKhDXzWihy4lNTNTgZFHKv/mdzo6bYz1DO+Ww7fsImKFXdn7T5xLGzYrQvjlbCZEsYtIAXudsxzorolybq2SsHQlRssd+VlcC5B9fAJDHhdZ4RlxGc0Zo25E5i7LtrIgDS3VEsoNpXlQvAvrLyubAiMwZ4Ag4/sq6C4YJWEzTqC+t7uc5vj1MogiaFsVJHnRZIhy9qQ== meloddik@watchtower"
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: compute0.ocp4.brakebills.io
    - path: /etc/modprobe.d/ixgbe.conf
      mode: 0644
      contents:
        inline: options ixgbe allow_unsupported_sfp=1
    - path: /etc/systemd/resolved.conf
      mode: 0644
      overwrite: true
      contents:
        source: http://192.168.1.152/resolved-conf
    - path: /etc/NetworkManager/system-connections/eno1.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=eno1
          type=ethernet
          interface-name=eno1
          [bond]
          miimon=100
          mode=802.3ad
          [ipv4]
          method=disabled
          [ipv6]
          method=disabled
    - path: /etc/NetworkManager/system-connections/eno2.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=eno2
          type=ethernet
          interface-name=eno2
          [bond]
          miimon=100
          mode=802.3ad
          [ipv4]
          method=disabled
          [ipv6]
          method=disabled
    - path: /etc/NetworkManager/system-connections/bond0.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=bond0
          type=bond
          interface-name=bond0
          [bond]
          miimon=100
          mode=802.3ad
          [ipv4]
          dns=10.1.30.8;
          dns-search=brakebills.io
          may-fail=false
          method=auto
          [ipv6]
          method=disabled
    - path: /etc/NetworkManager/system-connections/bond0-slave-eno1.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=bond0-slave-eno1
          type=ethernet
          interface-name=eno1
          master=bond0
          slave-type=bond
    - path: /etc/NetworkManager/system-connections/bond0-slave-eno2.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=bond0-slave-eno2
          type=ethernet
          interface-name=eno2
          master=bond0
          slave-type=bond
    - path: /usr/bin/reset-ixgbe
      mode: 0644
      contents:
        inline: |
          #!/bin/bash
          rmmod ixgbe
          modprobe ixgbe && systemctl restart NetworkManager
systemd:
  units:
    - name: reset-ixgbe.service
      enabled: true
      contents: |
        [Unit]
        Description=Reset ixgbe module arguments
        After=network.target

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/reset-ixgbe

        [Install]
        WantedBy=multi-user.target
